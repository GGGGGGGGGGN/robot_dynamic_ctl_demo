# 🐼 Panda 机械臂控制器设计文档

## 1. 系统架构 (System Architecture)

本项目采用 **基于模型的控制 (Model-Based Control)** 架构。核心思想是利用 Pinocchio 提供的精确动力学模型（RNEA/CRBA/ABA）来计算所需的关节力矩，从而抵消机器人的非线性动态特性。

### 控制闭环流程
1.  **状态估计 (State Estimation)**: 从 MuJoCo 获取关节位置 $q$ 和速度 $\dot{q}$。
2.  **模型更新 (Model Update)**: 将状态同步至 Pinocchio (`pin_dyn.update(q, dq)`).
3.  **控制律计算 (Control Law)**: 根据不同算法计算目标力矩 $\tau_{cmd}$。
4.  **力矩下发 (Actuation)**: 将力矩发送给 MuJoCo (`sim.set_joint_torque`).



---

## 2. 核心控制算法 (Control Algorithms)

我们将按难度递增的顺序实现以下控制器：

### 2.1 重力补偿 (Gravity Compensation)
最基础的校验算法。目的是抵消重力，使机械臂在空间中“失重”漂浮。
* **数学公式**:
    $$\tau = g(q)$$
* **应用场景**: 拖拽示教、零力控制验证、紧急制动后的悬停。

### 2.2 关节空间 PD 控制 (Joint Space PD Regulation)
让机械臂保持在特定的关节角度配置。
* **数学公式**:
    $$\tau = \underbrace{g(q)}_{\text{重力项}} + \underbrace{K_p (q_d - q) + K_d (\dot{q}_d - \dot{q})}_{\text{反馈项}}$$
* **特点**: 简单有效，但无法处理高速运动中的动力学耦合（如科氏力）。

### 2.3 计算力矩控制 (Computed Torque Control - CTC)
基于反馈线性化的轨迹跟踪算法。它能完美抵消惯性、科氏力和重力，使闭环系统表现为线性二阶系统。
* **数学公式**:
    $$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q, \dot{q})\dot{q} + g(q)$$
    其中 $e = q_d - q$。
* **应用场景**: 高速、高精度的轨迹跟踪（如画圆、写字）。

### 2.4 任务空间控制 (Task Space / Operational Space Control - OSC)
直接在笛卡尔空间（末端执行器）进行控制，而不需要解逆运动学（IK）。
* **数学公式** (简化版):
    $$\tau = J^T(q) \cdot \Lambda(q) \cdot (\ddot{x}_d + K_p \tilde{x} + K_d \dot{\tilde{x}}) + \mu(q, \dot{q}) + p(q)$$
* **特点**: 可以让末端表现得像弹簧-阻尼系统，适合与环境交互（如擦桌子、装配）。



---

## 3. 任务规划 (Tasks & Demos)

我们将编写不同的脚本来测试上述控制器：

| 任务名称 | 描述 | 对应控制器 | 目标 |
| :--- | :--- | :--- | :--- |
| **01_float** | 零重力漂浮 | Gravity Comp | 验证模型物理参数是否对齐 |
| **02_hold** | 姿态保持 | Joint PD | 验证反馈增益调节 |
| **03_track_joint** | 关节正弦轨迹跟踪 | CTC | 验证动态解耦能力 |
| **04_track_circle** | 末端画圆 | Task Space PD + Nullspace | 验证雅可比矩阵及零空间投影 |
| **05_push** | 阻抗交互 | Impedance Control | 验证柔顺性（推它会弹回来） |

---

## 4. 代码结构设计 (Code Structure)

```text
rm_control/
├── controllers/
│   ├── __init__.py
│   ├── base_controller.py   # 定义通用接口 (update, compute_torque)
│   ├── gravity_comp.py      # 重力补偿实现
│   ├── joint_pd.py          # 关节PD实现
│   ├── ctc_controller.py    # CTC实现
│   └── osc_controller.py    # 任务空间控制实现
├── demos/
│   ├── run_gravity.py
│   ├── run_ctc.py
│   └── ...