import time
import numpy as np
import mujoco

# å¯¼å…¥ä½ åˆšåˆšå®Œç¾ä¿®å¤çš„ SimInterface
from rm_control.simulation.sim_interface import SimInterface

def main():
    # 1. é…ç½®æ–‡ä»¶è·¯å¾„ (è¯·æ ¹æ®ä½ çš„å®é™…è·¯å¾„è°ƒæ•´)
    xml_path = "rm_control/assets/franka_emika_panda/scene.xml"  
    
    print("å¯åŠ¨ä»¿çœŸå¼•æ“å¹¶æŒ‚è½½è´Ÿè½½...")
    
    # 2. å®ä¾‹åŒ–ä»¿çœŸå™¨ï¼ŒæŒ‚è½½ 5kg é“å—
    sim = SimInterface(
        xml_path=xml_path, 
        render=True, 
        dt=0.001,
        payload_mass=5.0,              
        # Zè½´æ­£æ–¹å‘æ˜¯å¤¹çˆªå‘å¤–çš„æ–¹å‘ã€‚0.15m (15å˜ç±³) å¤§æ¦‚åœ¨å¤¹çˆªæŒ‡å°–
        payload_offset=[0.0, 0.0, 0.0], 
        payload_size=0.04 # è¿™æ˜¯ä¸€ä¸ªåŠè¾¹é•¿ï¼ŒçœŸå®è¾¹é•¿æ˜¯ 8cm x 8cm x 8cm
    )
    
    # 3. å°†æœºæ¢°è‡‚è®¾ç½®åˆ°ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“è§‚å¯Ÿçš„â€œä¸¾æ‰‹â€åˆå§‹å§¿æ€
    q_init = np.array([0.0, -0.5, 0.0, -2.0, 0.0, 1.5, 0.785])
    sim.data.qpos[:7] = q_init
    
    # å¼ºåˆ¶æ›´æ–°ä¸€æ¬¡è¿åŠ¨å­¦ï¼Œè®©å‡ ä½•ä½“åˆ·æ–°åˆ°æ­£ç¡®çš„ä½ç½®
    mujoco.mj_forward(sim.model, sim.data) 
    
    # ==========================================================
    # é™æ€è§‚å¯Ÿæ¨¡å¼ (åªæ¸²æŸ“ï¼Œä¸è®¡ç®—ç‰©ç†)
    # ==========================================================
    print("\n" + "="*50)
    print("ğŸ›‘ ä»¿çœŸç‰©ç†æ—¶é—´å·²é”å®šï¼ˆä¸ä¼šæ‰ä¸‹æ¥ï¼‰ï¼")
    print("ğŸ‘€ è¯·åœ¨å¼¹å‡ºçš„ MuJoCo çª—å£ä¸­ä»”ç»†æ£€æŸ¥è“è‰²è´Ÿè½½å—ï¼š")
    print("   1. ã€ä½ç½®ã€‘ï¼šæ˜¯ä¸æ˜¯æ­£å¥½æ‚¬æµ®åœ¨å¤¹çˆªçš„ä¸­å¤®/å‰æ–¹ï¼Ÿ")
    print("   2. ã€å¤§å°ã€‘ï¼š8cm ç«‹æ–¹ä½“çš„æ¯”ä¾‹æ˜¯å¦åˆé€‚ï¼Ÿ")
    print("\nğŸ’¡ æç¤ºï¼š")
    print("   - é¼ æ ‡å³é”®æ‹–åŠ¨ï¼šæ—‹è½¬è§†è§’")
    print("   - é¼ æ ‡æ»šè½®ï¼šç¼©æ”¾è§†è§’")
    print("   - é¼ æ ‡å·¦é”®åŒå‡»è´Ÿè½½å—ï¼šå¯ä»¥èšç„¦è§†è§’")
    print("âŒ æ£€æŸ¥å®Œæ¯•åï¼Œåœ¨ç»ˆç«¯æŒ‰ Ctrl+C é€€å‡ºç¨‹åºã€‚")
    print("="*50 + "\n")
    
    try:
        # æ­»å¾ªç¯ï¼šåªåŒæ­¥ç”»é¢ï¼Œç»å¯¹ä¸è°ƒç”¨ sim.step() æ¨è¿›æ—¶é—´ï¼
        while sim.is_alive():
            # ğŸ”¥ ä¿®æ”¹äº†è¿™é‡Œï¼šè°ƒç”¨æˆ‘ä»¬è‡ªå·±å°è£…çš„ renderï¼Œä¸ä»…åˆ·æ–°ç”»é¢ï¼Œè¿˜ä¼šæŠŠè“å—ç”»ä¸Šå»ï¼
            sim.render()
            time.sleep(0.02) # 50Hz çš„åˆ·æ–°ç‡ï¼Œè¶³å¤Ÿäººçœ¼è§‚çœ‹ä¸”ä¸å  CPU
    except KeyboardInterrupt:
        print("\né€€å‡ºé™æ€è§‚å¯Ÿæ¨¡å¼ã€‚")
    finally:
        sim.close()

if __name__ == "__main__":
    main()